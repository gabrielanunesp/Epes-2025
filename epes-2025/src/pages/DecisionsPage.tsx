import React, { useEffect, useMemo, useState } from "react";
import { db, auth } from "../services/firebase";
import {
  doc,
  getDoc,
  setDoc,
} from "firebase/firestore";
import { calcularRodada } from "../services/calcularRodadas";
import { useNavigate } from "react-router-dom";
import "./DecisionPage.css";

export default function DecisionPage() {
  const navigate = useNavigate();

  const [publicoAlvo, setPublicoAlvo] = useState("");
  const [membros, setMembros] = useState<{ uid: string; role?: string; isCapitao?: boolean }[]>([]);
  const [rodadaAtiva, setRodadaAtiva] = useState(false);
  const [rodadaAtual, setRodadaAtual] = useState(1);
  const [tempoRestante, setTempoRestante] = useState("");
  const [mensagemCapitao, setMensagemCapitao] = useState("");
  const [uid, setUid] = useState("");
  const [isCapitao, setIsCapitao] = useState(false);

  // marketSize e or√ßamento din√¢mico
  const [marketSize, setMarketSize] = useState<number>(10000);
  const [orcamentoRodada, setOrcamentoRodada] = useState<number>(500000);

  const codigoTurma = localStorage.getItem("codigoTurma") ?? "";
  const timeIdLS = localStorage.getItem("idDoTime") ?? "";

  // --------- auth + capitao ---------
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      if (user?.uid) {
        setUid(user.uid);
        if (!codigoTurma) return;

        const timeRef = doc(db, "times", codigoTurma);
        const timeSnap = await getDoc(timeRef);
        const timeData: any = timeSnap.data();

        const isOwner = timeData?.criadoPor === user.uid;
        const isMemberCaptain = Array.isArray(timeData?.membros)
          ? timeData.membros.some(
              (m: any) =>
                m?.uid === user.uid &&
                m?.status === "aprovado" &&
                (m?.role === "capitao" || m?.isCapitao === true)
            )
          : false;

        setIsCapitao(!!(isOwner || isMemberCaptain));
      }
    });
    return () => unsubscribe();
  }, [codigoTurma]);

  // --------- estados de decis√£o -----------
  // PRE√áO: mant√©m estrutura, mas com select fixo
  const opcoesPreco = [70, 90, 100, 110, 120];
  const [preco, setPreco] = useState<number>(100);

  const [produtoIndex, setProdutoIndex] = useState(0);
  const [marketingIndex, setMarketingIndex] = useState(0);
  const [capacidadeIndex, setCapacidadeIndex] = useState(1);
  const [equipeIndex, setEquipeIndex] = useState(0);
  const [marcaProtegida, setMarcaProtegida] = useState(false);
  const [beneficioIndex, setBeneficioIndex] = useState(3);

  const produtoOpcoes = ["B√°sico", "Intermedi√°rio", "Avan√ßado", "Premium"];
  const marketingOpcoes = ["Local", "Regional", "Nacional", "Nacional + Influenciadores"];
  const capacidadeOpcoes = ["500 unidades", "1.000 unidades", "2.000 unidades", "3.000 unidades"];
  const equipeOpcoes = ["Enxuto", "Balanceado", "Refor√ßado", "Especializado"];
  const beneficioOpcoes = ["Cupom", "Brinde", "Frete gr√°tis", "Nenhum"];

  const qualidade = [10, 20, 35, 50][produtoIndex];
  const marketingBonus = [8, 15, 25, 35][marketingIndex];
  const capacidade = [500, 1000, 2000, 3000][capacidadeIndex];
  const equipeBonus = [5, 15, 25, 30][equipeIndex];
  const beneficioBonus = [10, 15, 20, 0][beneficioIndex];
  const custoProtecao = marcaProtegida ? 80000 : 0;

  const totalUsado =
    [50000, 100000, 200000, 300000][produtoIndex] +
    [50000, 100000, 200000, 300000][marketingIndex] +
    [50000, 100000, 200000, 300000][capacidadeIndex] +
    [50000, 100000, 200000, 300000][equipeIndex] +
    [50000, 80000, 100000, 0][beneficioIndex] +
    custoProtecao;

  const caixaRestante = orcamentoRodada - totalUsado;
  const passouDoLimite = caixaRestante < 0;

  const formatar = (valor: number) => new Intl.NumberFormat("pt-BR").format(valor);

  // --------- carregar empresa + geral + orcamento din√¢mico ----------
  useEffect(() => {
    const carregar = async () => {
      const empresaRef = doc(db, "empresas", codigoTurma);
      const geralRef = doc(db, "configuracoes", "geral");

      const [empresaSnap, geralSnap] = await Promise.all([getDoc(empresaRef), getDoc(geralRef)]);
      const empresaData: any = empresaSnap.data();
      const geralData: any = geralSnap.data();

      if (empresaData?.publicoAlvo) setPublicoAlvo(empresaData.publicoAlvo);
      if (empresaData?.membros) setMembros(empresaData.membros);

      setRodadaAtiva(geralData?.rodadaAtiva === true);
      setRodadaAtual(geralData?.rodadaAtual ?? 1);

      setMarketSize(typeof geralData?.marketSize === "number" ? Number(geralData.marketSize) : 10000);

      // or√ßamento = 500k + soma(reinvestimento oficial) das rodadas anteriores
      await calcularOrcamentoDinamico(geralData?.rodadaAtual ?? 1);
    };

    const calcularOrcamentoDinamico = async (rodadaAtualServer: number) => {
      try {
        const tId = localStorage.getItem("idDoTime");
        if (!tId) {
          setOrcamentoRodada(500000);
          return;
        }

        let somaReinvest = 0;
        for (let r = 1; r < rodadaAtualServer; r++) {
          const docRef = doc(db, "resultadosOficiais", tId, `rodada${r}`, "oficial");
          const snap = await getDoc(docRef);
          if (snap.exists()) {
            const d: any = snap.data();
            const reinv = Number(d?.reinvestimento ?? 0);
            if (!isNaN(reinv)) somaReinvest += reinv;
          }
        }
        setOrcamentoRodada(500000 + somaReinvest);
      } catch {
        setOrcamentoRodada(500000);
      }
    };

    carregar();
  }, [codigoTurma]);

  // --------- cron√¥metro 23:59 ----------
  useEffect(() => {
    if (!rodadaAtiva) return;
    const atualizarTempo = () => {
      const agora = new Date();
      const fim = new Date();
      fim.setHours(23, 59, 0, 0);
      const diff = Math.max(0, fim.getTime() - agora.getTime());
      const horas = Math.floor(diff / 3600000);
      const minutos = Math.floor((diff % 3600000) / 60000);
      setTempoRestante(`${horas}h ${minutos}m`);
    };
    atualizarTempo();
    const interval = setInterval(atualizarTempo, 60000);
    return () => clearInterval(interval);
  }, [rodadaAtiva]);

  // --------- PREVIEW local ----------
  const resultado = useMemo(
    () =>
      calcularRodada({
        preco,               // agora vari√°vel
        qualidade,
        marketingBonus,
        equipeBonus,
        beneficioBonus,
        capacidade,
        publicoAlvo,
        caixaAcumulado: 0,
        marketSize,          // vem do Firestore
      }),
    [
      preco,
      qualidade,
      marketingBonus,
      equipeBonus,
      beneficioBonus,
      capacidade,
      publicoAlvo,
      marketSize,
    ]
  );

  const vendasEstimadas = useMemo(() => {
    const demanda = Number.isFinite(resultado.demanda) ? resultado.demanda : 0;
    return Math.min(demanda, capacidade, marketSize);
  }, [resultado.demanda, capacidade, marketSize]);

  // --------- salvar decis√£o ----------
  const salvarDecisao = async () => {
    try {
      const timeId = localStorage.getItem("idDoTime");

      const geralRef = doc(db, "configuracoes", "geral");
      const geralSnap = await getDoc(geralRef);
      const rodadaAtualServer = geralSnap.data()?.rodadaAtual ?? 1;

      if (!isCapitao) {
        setMensagemCapitao("üîí Apenas o capit√£o pode enviar a decis√£o final.");
        return;
      }
      if (!rodadaAtiva || passouDoLimite) return;

      if (!uid || !codigoTurma || !timeId || uid.trim() === "" || timeId.trim() === "") {
        setMensagemCapitao("‚ö†Ô∏è Informa√ß√µes incompletas. Verifique login e se voc√™ escolheu um time.");
        return;
      }

      // 1 por rodada (por capit√£o/time)
      const decisaoId = `${codigoTurma}_rodada${rodadaAtualServer}_${uid}`;
      const decisaoRef = doc(db, "decisoes", decisaoId);
      const jaTem = await getDoc(decisaoRef);
      if (jaTem.exists()) {
        setMensagemCapitao("üîí Esta equipe j√° enviou a decis√£o desta rodada.");
        return;
      }

      const dados = {
        produto: produtoOpcoes[produtoIndex],
        marketing: marketingOpcoes[marketingIndex],
        capacidade,
        equipe: equipeOpcoes[equipeIndex],
        marca: marcaProtegida,
        beneficio: beneficioOpcoes[beneficioIndex],

        preco, // << selecionado

        totalUsado,
        caixaRestante,
        publicoAlvo,

        // preview (sem concorr√™ncia)
        ea: resultado.ea ?? 0,
        share: resultado.share ?? 0,
        demanda: resultado.demanda ?? 0,
        receita: resultado.receita ?? 0,
        custo: resultado.custo ?? 0,
        lucro: resultado.lucro ?? 0,
        reinvestimento: resultado.reinvestimento ?? 0,
        caixaFinal: resultado.caixaFinal ?? 0,
        satisfacao: resultado.satisfacao ?? 0,

        // extras
        vendasPreview: vendasEstimadas,
        marketSizeUsado: marketSize,
        orcamentoUsado: orcamentoRodada,

        timestamp: new Date(),
        codigoTurma,
        uid,
        timeId,
        status: "‚úÖ",
      };

      // grava em "decisoes"
      await setDoc(decisaoRef, dados);

      // grava sub da rodada (auditoria)
      await setDoc(doc(db, "rodadas", codigoTurma, `rodada${rodadaAtualServer}`, uid), {
        timeId,
        ea: resultado.ea,
        demanda: resultado.demanda,
        receita: resultado.receita,
        custo: resultado.custo,
        lucro: resultado.lucro,
        reinvestimento: resultado.reinvestimento,
        caixaFinal: resultado.caixaFinal,
        satisfacao: resultado.satisfacao,
        atraso: false,
        status: "‚úÖ",
        timestamp: new Date(),
        marketSizeUsado: marketSize,
      });

      // espelho flat opcional
      await setDoc(doc(db, "rodadas", `${codigoTurma}_rodada${rodadaAtualServer}_${uid}`), dados);

      setMensagemCapitao("‚úÖ Decis√£o salva com sucesso!");
      setTimeout(() => navigate("/dashboard"), 600);
    } catch (err) {
      console.error("Erro ao salvar decis√£o:", err);
      setMensagemCapitao("‚ùå Erro ao salvar decis√£o. Tente novamente.");
    }
  };

  return (
    <div className="decision-container">
      <h2>üìä Decis√µes Estrat√©gicas</h2>

      <p style={{ marginTop: 4, color: "#666" }}>
        üßÆ Mercado desta rodada: {marketSize.toLocaleString("pt-BR")} consumidores
      </p>
      <p style={{ marginTop: 2, color: "#444" }}>
        üíº Or√ßamento dispon√≠vel: R$ {orcamentoRodada.toLocaleString("pt-BR")}
      </p>

      {/* PRE√áO (mantendo estrutura: label + select) */}
      <div className="decision-block">
        <label>üíµ Pre√ßo:</label>
        <select value={preco} onChange={(e) => setPreco(Number(e.target.value))}>
          {opcoesPreco.map((p) => (
            <option key={p} value={p}>
              R$ {p}
            </option>
          ))}
        </select>
      </div>

      <div className="decision-block">
        <label>üî¨ Produto & P&D:</label>
        <select value={produtoIndex} onChange={(e) => setProdutoIndex(Number(e.target.value))}>
          {produtoOpcoes.map((op, i) => (
            <option key={i} value={i}>{op}</option>
          ))}
        </select>
      </div>

      <div className="decision-block">
        <label>üì¢ Marketing & Branding:</label>
        <select value={marketingIndex} onChange={(e) => setMarketingIndex(Number(e.target.value))}>
          {marketingOpcoes.map((op, i) => (
            <option key={i} value={i}>{op}</option>
          ))}
        </select>
      </div>

      <div className="decision-block">
        <label>üè≠ Capacidade Operacional:</label>
        <select value={capacidadeIndex} onChange={(e) => setCapacidadeIndex(Number(e.target.value))}>
          {capacidadeOpcoes.map((op, i) => (
            <option key={i} value={i}>{op}</option>
          ))}
        </select>
      </div>

      <div className="decision-block">
        <label>üë• Equipe & Treinamento:</label>
        <select value={equipeIndex} onChange={(e) => setEquipeIndex(Number(e.target.value))}>
          {equipeOpcoes.map((op, i) => (
            <option key={i} value={i}>{op}</option>
          ))}
        </select>
      </div>

      <div className="decision-block">
        <label>üõ°Ô∏è Prote√ß√£o de Marca:</label>
        <select value={marcaProtegida ? "sim" : "nao"} onChange={(e) => setMarcaProtegida(e.target.value === "sim")}>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
        </select>
      </div>

      <div className="decision-block">
        <label>üéÅ Benef√≠cio de Lan√ßamento:</label>
        <select value={beneficioIndex} onChange={(e) => setBeneficioIndex(Number(e.target.value))}>
          {beneficioOpcoes.map((op, i) => (
            <option key={i} value={i}>{op}</option>
          ))}
        </select>
      </div>

      <p><strong>üí∏ Total usado:</strong> R$ {formatar(totalUsado)}</p>
      <p><strong>üßÆ Caixa restante:</strong> R$ {formatar(caixaRestante)}</p>

      <h3 style={{ marginTop: "2rem" }}>üìã Resumo das Decis√µes</h3>
      <div className="indicators">
        <p>
          üìà <span
            style={{ fontWeight: "bold", cursor: "pointer", textDecoration: "underline dotted" }}
            onClick={() => window.alert("Efeito de atratividade: representa o quanto sua oferta √© atrativa para o p√∫blico-alvo.")}
          >
            EA
          </span>: {resultado.ea}
        </p>

        {rodadaAtual > 1 ? (
          <p>
            üìä <span
              style={{ fontWeight: "bold", cursor: "pointer", textDecoration: "underline dotted" }}
              onClick={() => window.alert("Share: fatia de mercado conquistada pela sua empresa nesta rodada.")}
            >
              Share
            </span>: {resultado.share}%
          </p>
        ) : (
          <p className="indicator-note">üìä Share ser√° exibido a partir da segunda rodada.</p>
        )}

        <p>
          üõçÔ∏è <span
            style={{ fontWeight: "bold", cursor: "pointer", textDecoration: "underline dotted" }}
            onClick={() => window.alert("Estimativa de vendas nesta rodada (limitada por sua capacidade e tamanho de mercado).")}
          >
            Vendas (estimadas)
          </span>: {formatar(vendasEstimadas)}
        </p>

        <p>
          üí∞ <span
            style={{ fontWeight: "bold", cursor: "pointer", textDecoration: "underline dotted" }}
            onClick={() => window.alert("Valor estimado de receita nesta rodada.")}
          >
            Receita
          </span>: R$ {formatar(resultado.receita)}
        </p>

        <p>
          üìâ <span
            style={{ fontWeight: "bold", cursor: "pointer", textDecoration: "underline dotted" }}
            onClick={() => window.alert("Potencial de lucro para essa rodada.")}
          >
            Lucro
          </span>: R$ {formatar(resultado.lucro)}
        </p>

        <p>
          üè¶ <span
            style={{ fontWeight: "bold", cursor: "pointer", textDecoration: "underline dotted" }}
            onClick={() => window.alert("Saldo estimado ap√≥s custos e reinvestimento.")}
          >
            Caixa Final
          </span>: R$ {formatar(resultado.caixaFinal)}
        </p>
      </div>

      {!rodadaAtiva && (
        <div className="alert red">‚õî A rodada est√° fechada. Aguarde o respons√°vel iniciar a pr√≥xima rodada.</div>
      )}

      {rodadaAtiva && (
        <div className="alert green">‚úÖ Rodada ativa! Tempo restante: ‚è±Ô∏è {tempoRestante}</div>
      )}

      {passouDoLimite && (
        <div className="alert red">‚ùå Voc√™ ultrapassou o limite de investimento. Ajuste suas decis√µes para continuar.</div>
      )}

      {mensagemCapitao && (
        <div className="alert gray">{mensagemCapitao}</div>
      )}

      <button
        className="save-button"
        disabled={!rodadaAtiva || passouDoLimite}
        onClick={salvarDecisao}
      >
        üíæ Salvar Decis√£o
      </button>
    </div>
  );
}
